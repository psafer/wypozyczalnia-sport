<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Dodaj rezerwację</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
          <link
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  rel="stylesheet"
/>
  </head>

<body class="bg-light d-flex flex-column min-vh-100">
    <div id="header"></div>
    <main class="flex-grow-1">

    <div class="container mt-3">
      <h1 class="mb-4">Dodaj rezerwację</h1>

      <div id="error-msg" class="alert alert-danger d-none"></div>

      <div class="row">
        <div class="col-md-8">
          <form id="rezForm" class="card p-4 shadow-sm">
            <div class="mb-3">
              <label class="form-label">Wybierz sprzęt</label>
              <select id="eqId" class="form-select" required>
                <option value="" selected disabled>Ładowanie sprzętu...</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Wybierz klienta</label>
              <select class="form-select" id="clientSelect" required>
                <option value="" selected disabled>
                  Ładowanie klientów...
                </option>
              </select>
            </div>

            <div class="row mb-3">
              <div class="col">
                <label class="form-label">Data od</label>
                <input type="date" id="from" class="form-control" required />
              </div>
              <div class="col">
                <label class="form-label">Data do</label>
                <input type="date" id="to" class="form-control" required />
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label">Ilość sztuk</label>
              <input
                type="number"
                id="amount"
                class="form-control"
                value="1"
                min="1"
                required />
            </div>

            <button class="btn btn-success w-100 btn-lg">
              Zatwierdź rezerwację
            </button>
          </form>
        </div>

        <div class="col-md-4">
          <div class="card p-4 shadow-sm bg-white">
            <h4 class="card-title mb-3">Podsumowanie</h4>
            <p>Cena za dobę: <strong id="summary-price">0.00 PLN</strong></p>
            <p>Liczba dni: <strong id="summary-days">0</strong></p>
            <hr />
            <h3 class="text-primary">
              Razem: <span id="summary-total">0.00 PLN</span>
            </h3>
          </div>
        </div>
      </div>
    </div>
    </main>

    <script>
      function showError(message) {
        const errorDiv = document.getElementById("error-msg");
        errorDiv.textContent = message;
        errorDiv.classList.remove("d-none");
        window.scrollTo(0, 0);
      }

      // Pobieranie listy SPRZĘTU
      fetch("/sprzet")
        .then((res) => res.json())
        .then((data) => {
          const select = document.getElementById("eqId");
          select.innerHTML =
            '<option value="" selected disabled>Wybierz sprzęt...</option>';

          data.forEach((eq) => {
            const option = document.createElement("option");
            option.value = eq.id;
            option.dataset.max = eq.quantity;
            option.dataset.price = eq.pricePerDay; // Przechowujemy cenę w atrybucie opcji
            option.textContent = `${eq.name} (${eq.pricePerDay.toFixed(
              2,
            )} PLN/doba)`;

            if (eq.quantity <= 0) option.disabled = true;
            select.appendChild(option);
          });
        });

      // Pobieranie listy KLIENTÓW
      fetch("/klienci")
        .then((res) => res.json())
        .then((data) => {
          const select = document.getElementById("clientSelect");
          select.innerHTML =
            '<option value="" selected disabled>Wybierz klienta...</option>';
          data.forEach((c) => {
            const option = document.createElement("option");
            option.value = c.id;
            option.textContent = `${c.firstName} ${c.lastName}`;
            select.appendChild(option);
          });
        });

      // Dynamiczne obliczanie kosztów w locie
      function updateSummary() {
        const eqSelect = document.getElementById("eqId");
        const selectedOption = eqSelect.options[eqSelect.selectedIndex];
        const dateFrom = new Date(document.getElementById("from").value);
        const dateTo = new Date(document.getElementById("to").value);
        const amount = parseInt(document.getElementById("amount").value) || 0;

        if (
          selectedOption &&
          selectedOption.value &&
          !isNaN(dateFrom) &&
          !isNaN(dateTo)
        ) {
          const price = parseFloat(selectedOption.dataset.price);
          const diffTime = dateTo - dateFrom;
          let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          if (diffDays <= 0) diffDays = 1; // Minimalnie 1 dzień

          const total = diffDays * price * amount;

          document.getElementById("summary-price").textContent =
            price.toFixed(2) + " PLN";
          document.getElementById("summary-days").textContent = diffDays;
          document.getElementById("summary-total").textContent =
            total.toFixed(2) + " PLN";
        }
      }

      // Nasłuchiwanie zmian w polach formularza
      document
        .getElementById("rezForm")
        .addEventListener("input", updateSummary);

      // Obsługa wysyłki
      document
        .getElementById("rezForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          document.getElementById("error-msg").classList.add("d-none");

          const data = {
            equipmentId: parseInt(document.getElementById("eqId").value),
            clientId: parseInt(document.getElementById("clientSelect").value),
            dateFrom: document.getElementById("from").value,
            dateTo: document.getElementById("to").value,
            amount: parseInt(document.getElementById("amount").value),
          };

          if (data.dateFrom > data.dateTo) {
            alert(
              "Błąd: Data zwrotu nie może być wcześniejsza niż data wypożyczenia",
            );
            return;
          }

          fetch("/rezerwacje", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (response.ok) {
                alert("Rezerwacja dodana!");
                window.location.href = "rezerwacje.html";
              } else {
                return response.text().then((text) => {
                  throw new Error(text);
                });
              }
            })
            .catch((err) => {
              try {
                const errObj = JSON.parse(err.message);
                showError(errObj.error || "Błąd serwera.");
              } catch (e) {
                showError("Nie udało się połączyć z bazą danych.");
              }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
  fetch("header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header").innerHTML = html;

      const current = window.location.pathname.split("/").pop();
      document.querySelectorAll(".nav-link").forEach(link => {
        if (link.getAttribute("href") === current) {
          link.classList.add("active");
        }
      });
    });
     fetch("footer.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("footer").innerHTML = html;
    });
</script>
<div id="footer"></div>

  </body>
</html>
