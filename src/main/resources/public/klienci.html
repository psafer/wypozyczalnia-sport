<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Klienci</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <style>
      body {
        font-family: Arial, sans-serif;
        /* Margin usunięty na rzecz containerów bootstrapa, ale padding dodaje oddech */
        padding-bottom: 50px;
      }
      table {
        border-collapse: collapse;
      }
    </style>
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container">
        <a class="navbar-brand" href="index.html">Wypożyczalnia</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="sprzet.html">Sprzęt</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="add-sprzet.html">Dodaj sprzęt</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="rezerwacje.html">Rezerwacje</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="add-rezerwacja.html"
                >Dodaj rezerwację</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="klienci.html">Klienci</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-3">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Lista klientów</h1>
        <a href="add-klient.html" class="btn btn-success"
          >Dodaj nowego klienta</a
        >
      </div>

      <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Imię</th>
            <th>Nazwisko</th>
            <th>Telefon</th>
            <th>Nr Dokumentu</th>
            <th style="width: 200px">Akcje</th>
          </tr>
        </thead>
        <tbody id="clientsTableBody"></tbody>
      </table>
    </div>

    <!-- okno modalne do historii -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Historia wypożyczeń</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Sprzęt</th>
                  <th>Od</th>
                  <th>Do</th>
                  <th>Ilość</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="historyTableBody"></tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal">
              Zamknij
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Funkcja ładowania klientów (GET)
      function loadClients() {
        fetch("/klienci")
          .then((res) => res.json())
          .then((data) => {
            const tbody = document.getElementById("clientsTableBody");
            tbody.innerHTML = "";

            data.forEach((c) => {
              // Pola muszą odpowiadać nazwom w klasie Java (Client)
              const row = `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.firstName}</td>
                        <td>${c.lastName}</td>
                        <td>${c.phone}</td>
                        <td>${c.documentId}</td>
                        <td>
                            <button class="btn btn-sm btn-info text-white me-2" onclick="showHistory(${c.id})">Historia</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteClient(${c.id})">Usuń</button>
                        </td>
                    </tr>
                `;
              tbody.innerHTML += row;
            });
          })
          .catch((err) => console.error("Błąd ładowania danych:", err));
      }

      // Funkcja usuwania klienta (DELETE)
      function deleteClient(id) {
        if (!confirm("Czy na pewno chcesz usunąć tego klienta?")) {
          return;
        }

        fetch(`/klienci/${id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (res.status === 204 || res.ok) {
              // Odśwież tabelę po usunięciu
              loadClients();
            } else {
              alert("Wystąpił błąd podczas usuwania.");
            }
          })
          .catch((err) => console.error("Błąd usuwania:", err));
      }

      // Funkcja obsługi historii wypożyczeń klienta
      function showHistory(clientId) {
        const modalElement = document.getElementById("historyModal");
        const modal = new bootstrap.Modal(modalElement);
        const tbody = document.getElementById("historyTableBody");

        tbody.innerHTML =
          '<tr><td colspan="5" class="text-center">Ładowanie...</td></tr>';
        modal.show();

        fetch(`/klienci/${clientId}/history`)
          .then((res) => res.json())
          .then((data) => {
            tbody.innerHTML = "";
            if (data.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="5" class="text-center">Brak historii wypożyczeń dla tego klienta.</td></tr>';
              return;
            }

            data.forEach((r) => {
              const row = `
                    <tr>
                        <td><strong>${r.equipmentName}</strong></td>
                        <td>${r.dateFrom}</td>
                        <td>${r.dateTo}</td>
                        <td>${r.amount}</td>
                        <td><span class="badge bg-${
                          r.status === "ACTIVE" ? "success" : "secondary"
                        }">${r.status}</span></td>
                    </tr>
                `;
              tbody.innerHTML += row;
            });
          })
          .catch((err) => {
            console.error(err);
            tbody.innerHTML =
              '<tr><td colspan="5" class="text-danger">Błąd pobierania danych.</td></tr>';
          });
      }

      // Uruchomienie przy starcie strony
      loadClients();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
