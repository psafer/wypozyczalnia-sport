<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Lista sprzętu</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet" />
  </head>

  <body class="bg-light d-flex flex-column min-vh-100">

    <!-- HEADER -->
    <div id="header"></div>

    <!-- MAIN CONTENT -->
    <main class="flex-grow-1">
      <div class="container">
        <h1 class="mb-4">Lista sprzętu</h1>

        <div class="mb-3">
          <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="Szukaj po nazwie sprzętu..." />
        </div>

        <table class="table table-hover table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Nazwa</th>
              <th>Typ</th>
              <th>Na stanie</th>
              <th>Łącznie</th>
              <th>Status</th>
              <th>Akcja</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </main>

    <!-- FOOTER -->
    <div id="footer"></div>

    <!-- MODAL -->
    <div class="modal fade" id="addStockModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Dodaj sprzęt na stan</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="modalEquipmentId" />

            <div class="mb-3">
              <label class="form-label">Ilość do dodania</label>
              <input
                type="number"
                id="modalAmount"
                class="form-control"
                min="1"
                placeholder="np. 5" />
            </div>

            <div id="modalError" class="alert alert-danger d-none"></div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Anuluj
            </button>
            <button class="btn btn-primary" onclick="confirmAddStock()">
              Dodaj
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let allEquipment = [];

      function loadEquipment() {
        fetch("/sprzet")
          .then(res => res.json())
          .then(data => {
            allEquipment = data;
            renderEquipment(allEquipment);
          });
      }

      function renderEquipment(data) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        data.forEach(eq => {
          const statusBadge =
            eq.quantity > 0
              ? "<span class='badge bg-success'>Dostępny</span>"
              : "<span class='badge bg-danger'>Brak</span>";

          tbody.innerHTML += `
            <tr>
              <td>${eq.id}</td>
              <td>${eq.name}</td>
              <td>${eq.type}</td>
              <td>${eq.quantity}</td>
              <td>${eq.totalQuantity}</td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary"
                  onclick="openAddStockModal(${eq.id})">+ Dodaj</button>
                <button class="btn btn-sm btn-outline-danger ms-1"
                  onclick="deleteEquipment(${eq.id})">Usuń</button>
              </td>
            </tr>`;
        });
      }

      document.getElementById("searchInput").addEventListener("input", function () {
        const q = this.value.toLowerCase();
        renderEquipment(allEquipment.filter(eq =>
          eq.name.toLowerCase().includes(q)
        ));
      });

      let addStockModal;
      document.addEventListener("DOMContentLoaded", () => {
        addStockModal = new bootstrap.Modal(
          document.getElementById("addStockModal")
        );
      });

      function openAddStockModal(id) {
        document.getElementById("modalEquipmentId").value = id;
        document.getElementById("modalAmount").value = "";
        document.getElementById("modalError").classList.add("d-none");
        addStockModal.show();
      }

      function confirmAddStock() {
        const id = document.getElementById("modalEquipmentId").value;
        const amount = parseInt(document.getElementById("modalAmount").value);
        const errorDiv = document.getElementById("modalError");

        if (!amount || amount <= 0) {
          errorDiv.textContent = "Podaj poprawną ilość (> 0)";
          errorDiv.classList.remove("d-none");
          return;
        }

        fetch(`/sprzet/${id}/add-stock`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount }),
        })
          .then(res => {
            if (!res.ok) throw new Error();
            addStockModal.hide();
            loadEquipment();
          })
          .catch(() => {
            errorDiv.textContent = "Nie udało się dodać sprzętu";
            errorDiv.classList.remove("d-none");
          });
      }

      function deleteEquipment(id) {
        if (!confirm("Czy na pewno chcesz trwale usunąć ten sprzęt z bazy?")) return;

        fetch(`/sprzet/${id}`, { method: "DELETE" })
          .then(res => res.ok ? loadEquipment() : alert("Nie można usunąć sprzętu"));
      }

      loadEquipment();
    </script>

    <script>
      fetch("header.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("header").innerHTML = html;

          const current = window.location.pathname.split("/").pop();
          document.querySelectorAll(".nav-link").forEach(link => {
            if (link.getAttribute("href") === current) {
              link.classList.add("active");
            }
          });
        });

      fetch("footer.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("footer").innerHTML = html;
        });
    </script>

  </body>
</html>
