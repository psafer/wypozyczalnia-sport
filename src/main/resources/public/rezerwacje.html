<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Rezerwacje</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container">
        <a class="navbar-brand" href="index.html">Wypożyczalnia</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="sprzet.html">Sprzęt</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="add-sprzet.html">Dodaj sprzęt</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="rezerwacje.html">Rezerwacje</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="add-rezerwacja.html"
                >Dodaj rezerwację</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="klienci.html">Klienci</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-3">
      <h1 class="mb-4">Lista rezerwacji</h1>

      <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Sprzęt</th>
            <th>Klient</th>
            <th>Data od</th>
            <th>Data do</th>
            <th>Ilość</th>
            <th>Koszt</th>
            <th>Status</th>
            <th>Akcja</th>
          </tr>
        </thead>
        <tbody id="rezTableBody"></tbody>
      </table>
    </div>

    <script>
      function loadReservations() {
        fetch("/rezerwacje")
          .then((res) => res.json())
          .then((data) => {
            const tbody = document.getElementById("rezTableBody");
            tbody.innerHTML = "";

            data.forEach((r) => {
              const cost = r.totalCost
                ? parseFloat(r.totalCost).toFixed(2) + " zł"
                : "-";
              const statusBadge =
                r.status === "ACTIVE"
                  ? "<span class='badge bg-success'>Aktywna</span>"
                  : "<span class='badge bg-secondary'>Zwrócona</span>";

              let actionButton = "";

              if (r.status === "ACTIVE") {
                actionButton += `<button class="btn btn-sm btn-warning me-1" onclick="returnReservation(${r.id})">Zwróć</button>`;
              }

              actionButton += `<button class="btn btn-sm btn-danger" onclick="deleteReservation(${r.id})">Usuń</button>`;

              const row = `
                    <tr>
                        <td>${r.id}</td>
                        <td>${r.equipmentName}</td>
                        <td>${r.clientName}</td>
                        <td>${r.dateFrom}</td>
                        <td>${r.dateTo}</td>
                        <td>${r.amount}</td>
                        <td class="fw-bold">${cost}</td>
                        <td>${statusBadge}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;

              tbody.innerHTML += row;
            });
          })
          .catch((err) => {
            console.error(err);
            alert("Błąd ładowania rezerwacji");
          });
      }

      function returnReservation(id) {
        if (!confirm("Czy na pewno chcesz potwierdzić zwrot sprzętu?")) {
          return;
        }

        fetch(`/rezerwacje/${id}/zwrot`, {
          method: "POST",
        })
                .then((res) => {
                  if (!res.ok) {
                    return res.json().then(errData => {
                      throw new Error(errData.error || "Błąd zwrotu");
                    });
                  }
                  return res.json();
                })
                .then((data) => {
                  //Sprawdzamy czy przyszła kara
                  if (data.penalty && data.penalty > 0) {
                    //formatowanie kwoty do 2 miejsc po przecinku
                    const penaltyAmount = parseFloat(data.penalty).toFixed(2);
                    alert("Zwrot przyjęty.\nUWAGA! Naliczono karę za opóźnienie: " + penaltyAmount + " zł!");
                  } else {
                    alert("Zwrot przyjęty pomyślnie. Brak kar.");
                  }

                  loadReservations();
                })
                .catch((err) => {
                  console.error(err);
                  alert(err.message);
                });
      }

      function deleteReservation(id) {
        if (!confirm("Czy na pewno usunąć ten wpis?")) return;

        fetch(`/rezerwacje/${id}`, { method: "DELETE" }).then((res) => {
          if (res.ok) loadReservations();
          else alert("Błąd usuwania");
        });
      }

      loadReservations();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
