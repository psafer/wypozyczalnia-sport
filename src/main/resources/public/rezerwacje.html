<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Rezerwacje</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
          <link
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  rel="stylesheet"
/>
  </head>

<body class="bg-light d-flex flex-column min-vh-100">
    <div id="header"></div>
    <main class="flex-grow-1">
    <div class="container mt-3">
      <h1 class="mb-4">Lista rezerwacji</h1>
      <div class="mb-3">
      <input
        type="text"
        id="searchInput"
        class="form-control"
        placeholder="Szukaj po imieniu lub nazwisku klienta..."
      />
    </div>
      <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Sprzęt</th>
            <th>Klient</th>
            <th>Data od</th>
            <th>Data do</th>
            <th>Ilość</th>
            <th>Koszt</th>
            <th>Status</th>
            <th>Akcja</th>
          </tr>
        </thead>
        <tbody id="rezTableBody"></tbody>
      </table>
    </div>
</main> 
    <script>
      let allReservations = [];

      function loadReservations() {
        fetch("/rezerwacje")
          .then((res) => res.json())
          .then((data) => {
            // SORT: najnowsze na górze (po dateFrom)
            allReservations = data.sort((a, b) => {
              const d1 = new Date(a.dateFrom);
              const d2 = new Date(b.dateFrom);
              return d2 - d1;
            });

            renderReservations(allReservations);
          })
          .catch((err) => {
            console.error(err);
            alert("Błąd ładowania rezerwacji");
          });
      }

      function renderReservations(data) {
        const tbody = document.getElementById("rezTableBody");
        tbody.innerHTML = "";

        data.forEach((r) => {
          const cost = r.totalCost
            ? parseFloat(r.totalCost).toFixed(2) + " zł"
            : "-";

          const statusBadge =
            r.status === "ACTIVE"
              ? "<span class='badge bg-success'>Aktywna</span>"
              : "<span class='badge bg-secondary'>Zwrócona</span>";

          let actionButton = "";

          if (r.status === "ACTIVE") {
            actionButton += `<button class="btn btn-sm btn-warning me-1" onclick="returnReservation(${r.id})">Zwróć</button>`;
          }

          actionButton += `<button class="btn btn-sm btn-danger" onclick="deleteReservation(${r.id})">Usuń</button>`;

          tbody.innerHTML += `
            <tr>
              <td>${r.id}</td>
              <td>${r.equipmentName}</td>
              <td>${r.clientName}</td>
              <td>${r.dateFrom}</td>
              <td>${r.dateTo}</td>
              <td>${r.amount}</td>
              <td class="fw-bold">${cost}</td>
              <td>${statusBadge}</td>
              <td>${actionButton}</td>
            </tr>
          `;
        });
      }

      // LIVE SEARCH
      document.getElementById("searchInput").addEventListener("input", function () {
        const query = this.value.toLowerCase();

        const filtered = allReservations.filter((r) =>
          r.clientName.toLowerCase().includes(query)
        );

        renderReservations(filtered);
      });


      function returnReservation(id) {
        if (!confirm("Czy na pewno chcesz potwierdzić zwrot sprzętu?")) {
          return;
        }

        fetch(`/rezerwacje/${id}/zwrot`, {
          method: "POST",
        })
                .then((res) => {
                  if (!res.ok) {
                    return res.json().then(errData => {
                      throw new Error(errData.error || "Błąd zwrotu");
                    });
                  }
                  return res.json();
                })
                .then((data) => {
                  //Sprawdzamy czy przyszła kara
                  if (data.penalty && data.penalty > 0) {
                    //formatowanie kwoty do 2 miejsc po przecinku
                    const penaltyAmount = parseFloat(data.penalty).toFixed(2);
                    alert("Zwrot przyjęty.\nUWAGA! Naliczono karę za opóźnienie: " + penaltyAmount + " zł!");
                  } else {
                    alert("Zwrot przyjęty pomyślnie. Brak kar.");
                  }

                  loadReservations();
                })
                .catch((err) => {
                  console.error(err);
                  alert(err.message);
                });
      }

      function deleteReservation(id) {
        if (!confirm("Czy na pewno usunąć ten wpis?")) return;

        fetch(`/rezerwacje/${id}`, { method: "DELETE" }).then((res) => {
          if (res.ok) loadReservations();
          else alert("Błąd usuwania");
        });
      }

      loadReservations();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
  fetch("header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header").innerHTML = html;

      const current = window.location.pathname.split("/").pop();
      document.querySelectorAll(".nav-link").forEach(link => {
        if (link.getAttribute("href") === current) {
          link.classList.add("active");
        }
      });
    });
     fetch("footer.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("footer").innerHTML = html;
    });
</script>
<div id="footer"></div>

  </body>
</html>
